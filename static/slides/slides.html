---
title: "Data Visualization in R"
subtitle: ""
author: "Tiago Ventura"
institute: "University of Maryland"
date: ""
output:
  xaringan::moon_reader:
    css: ["default", "styles.css", "fontsrladies.css"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<div id="main-ideas-for-this-workshop" class="section level2">
<h2>Main Ideas for this Workshop</h2>
<table style="width:4%;">
<colgroup>
<col width="4%" />
</colgroup>
<tbody>
<tr class="odd">
<td>- Hands-on Data Visualization Workshop.</td>
</tr>
</tbody>
</table>
<ul>
<li>Show a complete workflow to build nice visualization.</li>
</ul>
<p>–</p>
<ul>
<li><h2 id="prepare-your-data-before-plotting.">Prepare your data before plotting.</h2></li>
<li>Show you how to go from your models to nice visualizations.</li>
</ul>
<p>–</p>
<hr />
<p>class: center, middle</p>
</div>
<div id="my-approach" class="section level1">
<h1>My approach</h1>
<p><strong>Always better to present your results with a graph</strong></p>
<p>And keep all (or most of) your models and descriptive tables in the appendix.</p>
<p>class:inverse, center, middle</p>
</div>
<div id="basics-of-ggplot2" class="section level1">
<h1>Basics of ggplot2</h1>
</div>
<div id="how-ggplot-works" class="section level1">
<h1>How ggplot works</h1>
<ul>
<li><p>Data Visualization involves connecting (mapping) variables from your data to graphical representations.</p></li>
<li><p>Ggplot provides you with a language to map data and to a plot.</p></li>
<li><p>Ggplot works by connecting data and visual components through a function called <strong>aesthethics mapping</strong> (aes).</p></li>
<li><p>Every graph is built layer by layer starting with your data, aesthetics mappings, geometric decisions, and then embelisshment of the plot.</p></li>
</ul>
<hr />
</div>
<div id="summary" class="section level1">
<h1>Summary</h1>
<p>.pull-left[
<img src="ggplot_flow1.png" width="70%" />]</p>
<p>.pull-right[
<img src="ggplot_flow2.png" width="62%" />]</p>
</div>
<div id="starting-some-coding" class="section level1">
<h1>Starting some coding</h1>
<p>Let’s first call our packages. I am using the package <a href="http://trinker.github.io/pacman/vignettes/Introduction_to_pacman.html">packman</a> to help me manage my libraries.</p>
<pre class="r"><code>pacman::p_load(tidyverse, gapminder, kableExtra, tidyr, ggthemes, patchwork, broom)</code></pre>
<p>This is a tidy data:</p>
<pre class="r"><code>knitr::kable(head(gapminder), format = &#39;html&#39;)</code></pre>
<table>
<thead>
<tr>
<th style="text-align:left;">
country
</th>
<th style="text-align:left;">
continent
</th>
<th style="text-align:right;">
year
</th>
<th style="text-align:right;">
lifeExp
</th>
<th style="text-align:right;">
pop
</th>
<th style="text-align:right;">
gdpPercap
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Afghanistan
</td>
<td style="text-align:left;">
Asia
</td>
<td style="text-align:right;">
1952
</td>
<td style="text-align:right;">
28.801
</td>
<td style="text-align:right;">
8425333
</td>
<td style="text-align:right;">
779.4453
</td>
</tr>
<tr>
<td style="text-align:left;">
Afghanistan
</td>
<td style="text-align:left;">
Asia
</td>
<td style="text-align:right;">
1957
</td>
<td style="text-align:right;">
30.332
</td>
<td style="text-align:right;">
9240934
</td>
<td style="text-align:right;">
820.8530
</td>
</tr>
<tr>
<td style="text-align:left;">
Afghanistan
</td>
<td style="text-align:left;">
Asia
</td>
<td style="text-align:right;">
1962
</td>
<td style="text-align:right;">
31.997
</td>
<td style="text-align:right;">
10267083
</td>
<td style="text-align:right;">
853.1007
</td>
</tr>
<tr>
<td style="text-align:left;">
Afghanistan
</td>
<td style="text-align:left;">
Asia
</td>
<td style="text-align:right;">
1967
</td>
<td style="text-align:right;">
34.020
</td>
<td style="text-align:right;">
11537966
</td>
<td style="text-align:right;">
836.1971
</td>
</tr>
<tr>
<td style="text-align:left;">
Afghanistan
</td>
<td style="text-align:left;">
Asia
</td>
<td style="text-align:right;">
1972
</td>
<td style="text-align:right;">
36.088
</td>
<td style="text-align:right;">
13079460
</td>
<td style="text-align:right;">
739.9811
</td>
</tr>
<tr>
<td style="text-align:left;">
Afghanistan
</td>
<td style="text-align:left;">
Asia
</td>
<td style="text-align:right;">
1977
</td>
<td style="text-align:right;">
38.438
</td>
<td style="text-align:right;">
14880372
</td>
<td style="text-align:right;">
786.1134
</td>
</tr>
</tbody>
</table>
<hr />
</div>
<div id="tidy-data" class="section level1">
<h1>Tidy Data</h1>
<p>There are three interrelated rules which make a <a href="https://r4ds.had.co.nz/tidy-data.html">dataset tidy</a>.</p>
<ul>
<li>Each variable must have its own column.</li>
<li>Each observation must have its own row.</li>
<li>Each value must have its own cell.</li>
</ul>
<p><img src="tidy.png" width="100%" /></p>
<hr />
</div>
<div id="getting-our-own-data" class="section level1">
<h1>Getting our own data</h1>
<pre class="r"><code>data &lt;- read_csv(&quot;https://docs.google.com/spreadsheets/d/e/2PACX-1vQ56fySJKLL18Lipu1_i3ID9JE06voJEz2EXm6JW4Vh11zmndyTwejMavuNntzIWLY0RyhA1UsVEen0/pub?gid=0&amp;single=true&amp;output=csv&quot;)</code></pre>
<div id="is-this-data-tidy-you-can-say-just-checking-colnames" class="section level3">
<h3>Is this data tidy? (You can say just checking colnames)</h3>
<pre><code>##  [1] &quot;state&quot;                  &quot;pollster&quot;               &quot;sponsor&quot;               
##  [4] &quot;start.date&quot;             &quot;end.date&quot;               &quot;entry.date.time..et.&quot;  
##  [7] &quot;number.of.observations&quot; &quot;population&quot;             &quot;mode&quot;                  
## [10] &quot;biden&quot;                  &quot;trump&quot;                  &quot;biden_margin&quot;          
## [13] &quot;other&quot;                  &quot;undecided&quot;              &quot;url&quot;                   
## [16] &quot;include&quot;                &quot;notes&quot;</code></pre>
</div>
<div id="and-now" class="section level2">
<h2>And now:</h2>
<pre class="r"><code>data_long %&gt;% 
  select(Vote_Choice, Vote) %&gt;%
  slice(1:5)</code></pre>
<pre><code>## # A tibble: 5 x 2
##   Vote_Choice  Vote
##   &lt;chr&gt;       &lt;dbl&gt;
## 1 biden          45
## 2 trump          50
## 3 biden          52
## 4 trump          40
## 5 biden          47</code></pre>
<p><br>
<br></p>
<div id="centerwith-this-tidy-dataset-we-can-start-our-visualizations." class="section level3">
<h3>.center[With this tidy dataset, we can start our visualizations.]</h3>
</div>
</div>
<div id="linking-the-data-to-visuals-mapping." class="section level2">
<h2>Linking the Data to Visuals (Mapping).</h2>
<p>Mapping is how you connect your data and variables with the visual representations of a graph. We will do this in two steps.</p>
<p>–</p>
<ul>
<li><strong>The Data Step</strong>: Tell ggplot what your data is.</li>
</ul>
<p>–</p>
<ul>
<li><strong>The Mapping Step:</strong> Tell ggplot <strong>what</strong> variables -&gt; visuals you want to see.</li>
</ul>
<p>–</p>
<ul>
<li><strong>The Geom Step:</strong> Tell ggplot <strong>how</strong> you want to see</li>
</ul>
<p>–</p>
<hr />
</div>
</div>
<div id="polls-over-time-ugly-but-with-the-basics" class="section level1">
<h1>Polls Over Time (Ugly but with the basics)</h1>
<pre class="r"><code>ggplot(data=national_polls, # the data step 
       aes(x=end.date, y=Vote)) + # the map step
geom_point() # the geom step</code></pre>
<p><img src="static/slides/slides_files/figure-html/unnamed-chunk-11-1.png" width="60%" /></p>
<hr />
</div>
<div id="aesthethics-color" class="section level1">
<h1>Aesthethics: Color</h1>
<pre class="r"><code>ggplot(data=national_polls, # the data step
       aes(x=end.date, y=Vote, 
           color=Vote_Choice)) + # the map step
geom_point()</code></pre>
<p><img src="static/slides/slides_files/figure-html/unnamed-chunk-12-1.png" width="60%" /></p>
<hr />
</div>
<div id="aesthethics-shape" class="section level1">
<h1>Aesthethics: Shape</h1>
<pre class="r"><code>ggplot(data=national_polls, # the data step
       aes(x=end.date, y=Vote,
           color=Vote_Choice,
           shape=Vote_Choice)) + # the map step
geom_point() </code></pre>
<p><img src="static/slides/slides_files/figure-html/unnamed-chunk-13-1.png" width="60%" /></p>
<hr />
</div>
<div id="aesthethics-alpha" class="section level1">
<h1>Aesthethics: Alpha</h1>
<pre class="r"><code>ggplot(data=national_polls, # the data step
       aes(x=end.date, y=Vote,
           color=Vote_Choice,
           shape=Vote_Choice, 
           alpha=end.date)) + # the map step
geom_point() </code></pre>
<p><img src="static/slides/slides_files/figure-html/unnamed-chunk-14-1.png" width="60%" /></p>
<hr />
</div>
<div id="aesthethics-linetype" class="section level1">
<h1>Aesthethics: Linetype</h1>
<pre class="r"><code>ggplot(data=national_polls, # the data step
       aes(x=end.date, y=Vote)) + # the map step
geom_smooth(aes(linetype=Vote_Choice)) +
geom_point(aes(color=Vote_Choice), alpha=.2)</code></pre>
<p><img src="static/slides/slides_files/figure-html/unnamed-chunk-15-1.png" width="60%" /></p>
<hr />
</div>
<div id="some-notes" class="section level1">
<h1>Some notes</h1>
<ul>
<li><p>You can use multiple aesthetics together.</p></li>
<li><p>One variables for each aesthethic (that’s why your data should be tidy)</p></li>
<li><p>Outside of Aes, the aesthetics work with a simple value, not a variable linking data and geoms.</p></li>
</ul>
</div>
<div id="smooting-the-data" class="section level1">
<h1>Smooting the data</h1>
<pre class="r"><code>ggplot(data=national_polls,
       aes(x=end.date, y=Vote, color=Vote_Choice, fill=Vote_Choice)) + 
geom_point(alpha=.2) +
geom_smooth()</code></pre>
<p><img src="static/slides/slides_files/figure-html/unnamed-chunk-16-1.png" width="60%" /></p>
<hr />
</div>
<div id="density" class="section level1">
<h1>Density</h1>
<pre class="r"><code>ggplot(data=national_polls,
       aes(x=end.date)) +
geom_density(fill=&quot;steelblue&quot;)</code></pre>
<p><img src="static/slides/slides_files/figure-html/unnamed-chunk-17-1.png" width="60%" /></p>
<hr />
</div>
<div id="nice-trick-facet-wrap" class="section level1">
<h1>Nice Trick: facet wrap</h1>
<pre class="r"><code>ggplot(data=state_polls %&gt;% filter(state%in%swing_states)) +
  geom_density(aes(x=end.date, fill=state), alpha=.3) +
  facet_wrap(~state, ncol=3)</code></pre>
<p><img src="static/slides/slides_files/figure-html/unnamed-chunk-18-1.png" width="60%" /></p>
<hr />
</div>
<div id="bars" class="section level1">
<h1>Bars</h1>
<pre class="r"><code>ggplot(data=data_long,
       aes(x=end.date, fill=mode)) +
geom_bar() +
scale_fill_brewer(palette = &quot;Set3&quot;)</code></pre>
<p><img src="static/slides/slides_files/figure-html/unnamed-chunk-19-1.png" width="60%" /></p>
<hr />
</div>
<div id="box-plot" class="section level1">
<h1>Box Plot</h1>
<pre class="r"><code># Another example
ggplot(state_polls %&gt;% filter(state%in%swing_states),
       aes(x=Vote,y=fct_rev(state), fill=Vote_Choice)) +
  geom_boxplot() +
  scale_fill_manual(values=c(&quot;biden&quot;=&quot;blue&quot;,&quot;trump&quot;=&quot;red&quot;)) </code></pre>
<p><img src="static/slides/slides_files/figure-html/unnamed-chunk-20-1.png" width="60%" /></p>
<div id="part-4-adjust-scales-labels-titles-and-more." class="section level2">
<h2>Part 4: Adjust scales, labels, titles, and more.</h2>
<p>After you are set on the mapping and geoms, the next step is to adjust the scale of your the graph. These functions are usually on the form: <code>scale_aesthethic_type</code>.</p>
<ul>
<li><code>scale_x_log10</code>: To convert the numeric axis to the log scale</li>
<li><code>scale_y_reverse</code>: To reverse the scale</li>
<li><code>scale_fill_manual</code>: To create your own discrete set of fill.</li>
<li><code>scale_colour_brewer()</code>: Change the Pallet of Colours</li>
</ul>
<hr />
</div>
</div>
<div id="putting-all-together" class="section level1">
<h1>Putting all together</h1>
<pre class="r"><code>p &lt;- ggplot(data=national_polls,
       aes(x=end.date, y=Vote, color=Vote_Choice, 
           shape=Vote_Choice, fill=Vote_Choice)) + 
geom_point(alpha=.2) +
geom_smooth() +
scale_shape_manual(values =c(21, 23)) +
scale_fill_manual(values=c(&quot;red&quot;, &quot;blue&quot;)) +
scale_color_manual(values=c(&quot;red&quot;, &quot;blue&quot;), 
                   labels=c(&quot;Biden&quot;, &quot;Trump&quot;), 
                   name= &quot;Vote Choice&quot;) +
scale_x_date(date_breaks = &quot;1 month&quot;, date_labels = &quot;%b %d&quot;) +
guides(fill=FALSE, shape=FALSE) +
labs(x = &quot;End of the Poll&quot;, y = &quot;Results&quot;,
         title = &quot;Polls US Presidential Election&quot;,
         subtitle = &quot;&quot;,
         caption = &quot;Source: The Economist&quot;)  </code></pre>
</div>
<div id="part-5-embellishment-as-an-consistent-workflow" class="section level1">
<h1>Part 5: Embellishment as an consistent workflow</h1>
<ul>
<li><p>Most of the adjustments you can make on your plot go inside of the <code>theme</code> function.</p></li>
<li><p>When working in a paper, you should be consistent with your graphs.</p></li>
<li><p>Create your own theme, and apply to all your codes.</p></li>
</ul>
<hr />
</div>
<div id="build-your-theme" class="section level1">
<h1>Build Your Theme</h1>
<pre class="r"><code># Set up my theme  ------------------------------------------------------------
my_font &lt;- &quot;Palatino Linotype&quot;
my_bkgd &lt;- &quot;#f5f5f2&quot;
pal &lt;- RColorBrewer::brewer.pal(9, &quot;Spectral&quot;)
my_theme &lt;- theme(text = element_text(family = my_font, color = &quot;#22211d&quot;),
            rect = element_rect(fill = my_bkgd),
            plot.background = element_rect(fill = my_bkgd, color = NA),
            panel.background = element_rect(fill = my_bkgd, color = NA),
            panel.border = element_rect(color=&quot;black&quot;), 
            strip.background = element_rect(color=&quot;black&quot;, fill=&quot;gray85&quot;), 
            legend.background = element_rect(fill = my_bkgd, color = NA),
            legend.key = element_rect(size = 6, fill = &quot;white&quot;, colour = NA), 
            legend.key.size = unit(1, &quot;cm&quot;),
            legend.text = element_text(size = 10, family = my_font),
            legend.title = element_text(size=10),
            plot.title = element_text(size = 22, face = &quot;bold&quot;, family=my_font),
            plot.subtitle = element_text(size=16, family=my_font),
            axis.title= element_text(size=14),
            axis.text = element_text(size=8, family=my_font),
            axis.title.x = element_text(hjust=1),
            strip.text = element_text(family = my_font, color = &quot;#22211d&quot;,
                                            size = 10, face=&quot;italic&quot;))</code></pre>
<pre class="r"><code># This sets up for all your plots

theme_set(theme_bw() + my_theme) #&lt;&lt;</code></pre>
<hr />
<div id="or-by-hand-for-each-plot" class="section level2">
<h2>Or by hand for each plot</h2>
<p>.pull-left[</p>
<pre class="r"><code>p +
  theme_bw() + 
  my_theme</code></pre>
<p>]</p>
<table>
<tbody>
<tr class="odd">
<td>.pull-right[</td>
</tr>
<tr class="even">
<td><img src="static/slides/slides_files/figure-html/unnamed-chunk-27-1.png" width="100%" /></td>
</tr>
<tr class="odd">
<td>]</td>
</tr>
</tbody>
</table>
<hr />
</div>
</div>
<div id="pre-built-plots" class="section level1">
<h1>Pre-built plots</h1>
<p>There are several packages in R and built-in in gpplot with pre-built themes. Some examples from <code>ggthemes</code> and <code>hrbrthemes</code></p>
<ul>
<li><p>theme_minimal()</p></li>
<li><p>theme_economist()</p></li>
<li><p>theme_fivethirtyeight()</p></li>
<li><p>theme_ipsum()</p></li>
</ul>
<hr />
<p>.pull-left[</p>
<pre class="r"><code>p +
  theme_minimal(base_size=12)</code></pre>
<p><img src="static/slides/slides_files/figure-html/unnamed-chunk-28-1.png" width="672" />
]</p>
<p>.pull-right[</p>
<pre class="r"><code>p +
  theme_fivethirtyeight() </code></pre>
<p><img src="static/slides/slides_files/figure-html/unnamed-chunk-29-1.png" width="672" />
]</p>
</div>
<div id="broom" class="section level1">
<h1>Broom</h1>
<ul>
<li><p>We have discussed how to go from your raw data to informative visualization plots.</p></li>
<li><p>From this section forward, we will use the same logic to go from your statistical models outputs to plots.</p></li>
<li><p>We will use David Robinson’s <code>broom</code> package to help us out, and the tidyverse package <code>purrr</code>.</p></li>
</ul>
<div id="a-simple-model" class="section level3">
<h3>A Simple Model</h3>
<pre class="r"><code># Separate the data
biden &lt;- national_polls %&gt;%
      filter(Vote_Choice==&quot;biden&quot;) %&gt;%
      mutate(first_day=min(end.date, na.rm=TRUE), 
             days=as.numeric(end.date-first_day))

# simple linear model

lm_time &lt;- lm(Vote~ days, data=biden)</code></pre>
<hr />
</div>
</div>
<div id="extract-quantities-with-broom" class="section level1">
<h1>Extract Quantities with Broom</h1>
<ul>
<li><code>tidy</code>: to extract the model main parameters</li>
<li><code>augment</code>: to extract observation-level statistics (predictions)</li>
<li><code>glance</code>: to extract model-level statistics.</li>
</ul>
<div id="tidy-extract-quantities" class="section level2">
<h2>Tidy: Extract Quantities</h2>
<pre class="r"><code># a data frame
results &lt;- tidy(lm_time)
results</code></pre>
<pre><code>## # A tibble: 2 x 5
##   term        estimate std.error statistic  p.value
##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 (Intercept)  46.7      0.318       147.  0.      
## 2 days          0.0164   0.00156      10.5 2.06e-23</code></pre>
<hr />
</div>
</div>
<div id="augment-predicted-values" class="section level1">
<h1>Augment: Predicted Values</h1>
<pre class="r"><code>augment(lm_time)</code></pre>
<pre><code>## # A tibble: 495 x 8
##     Vote  days .fitted .resid .std.resid    .hat .sigma   .cooksd
##    &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;      &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;
##  1    52   305    51.7  0.339      0.126 0.00653   2.71 0.0000519
##  2    52   304    51.6  0.355      0.132 0.00645   2.71 0.0000564
##  3    51   304    51.6 -0.645     -0.239 0.00645   2.71 0.000185 
##  4    52   306    51.7  0.323      0.120 0.00661   2.71 0.0000476
##  5    48   304    51.6 -3.64      -1.35  0.00645   2.70 0.00593  
##  6    50   305    51.7 -1.66      -0.616 0.00653   2.71 0.00125  
##  7    53   305    51.7  1.34       0.497 0.00653   2.71 0.000810 
##  8    53   306    51.7  1.32       0.491 0.00661   2.71 0.000800 
##  9    53   305    51.7  1.34       0.497 0.00653   2.71 0.000810 
## 10    50   306    51.7 -1.68      -0.622 0.00661   2.71 0.00129  
## # … with 485 more rows</code></pre>
<hr />
</div>
<div id="plot-the-predicted-values" class="section level1">
<h1>Plot The Predicted Values</h1>
<pre class="r"><code># Plot
augment(lm_time, se_fit = TRUE) %&gt;% 
  mutate(lb=.fitted - 1.96*.se.fit, 
         ub=.fitted + 1.96*.se.fit) %&gt;%
ggplot(data=.) +  geom_ribbon(aes(y=.fitted, ymin=lb,
                  ymax=ub, x=days), alpha=.2) +
  geom_line(aes(y=.fitted, x=days), color=&quot;blue&quot;) +
  geom_point(aes(y = Vote, x=days), alpha=.2) </code></pre>
<p><img src="static/slides/slides_files/figure-html/unnamed-chunk-33-1.png" width="60%" /></p>
<div id="running-multiple-models" class="section level2">
<h2>Running Multiple Models</h2>
<p>What if I want to run the same model for multiple subgroups? Or multiple different models?</p>
<p>Use <code>purrr</code> for functional programming. This is where R and tidyverse gets really beautiful.</p>
<p>The logic is simple. We will nest our data, run models in the subgroups, tidy the results, and unnest everything in a tidy format dataset.</p>
</div>
<div id="nest-the-data" class="section level2">
<h2>Nest the Data</h2>
<pre class="r"><code># Step 1: Nest your data
nested_data &lt;- state_polls %&gt;%
                 filter(Vote_Choice==&quot;biden&quot;) %&gt;%
                 mutate(first_day=min(end.date, na.rm=TRUE), 
                         days=as.numeric(end.date-first_day)) %&gt;%
                 group_by(state) %&gt;% #&lt;&lt;
                 nest() #&lt;&lt;

nested_data</code></pre>
<pre><code>## # A tibble: 47 x 2
## # Groups:   state [47]
##    state data               
##    &lt;chr&gt; &lt;list&gt;             
##  1 MT    &lt;tibble [18 × 18]&gt; 
##  2 ME    &lt;tibble [19 × 18]&gt; 
##  3 IA    &lt;tibble [32 × 18]&gt; 
##  4 WI    &lt;tibble [95 × 18]&gt; 
##  5 PA    &lt;tibble [112 × 18]&gt;
##  6 NC    &lt;tibble [104 × 18]&gt;
##  7 MI    &lt;tibble [112 × 18]&gt;
##  8 FL    &lt;tibble [105 × 18]&gt;
##  9 AZ    &lt;tibble [88 × 18]&gt; 
## 10 MN    &lt;tibble [34 × 18]&gt; 
## # … with 37 more rows</code></pre>
<p>The data column is called a <a href="https://jennybc.github.io/purrr-tutorial/ls13_list-columns.html">list-column</a> because it works as a list where every element has a entire dataset.</p>
<p>With a list of datasets, we can use functional programming in <code>purrr</code> to run the same models for each dataset.</p>
<hr />
</div>
<div id="run-the-models" class="section level2">
<h2>Run the Models</h2>
<pre class="r"><code>nested_data &lt;- nested_data %&gt;%
                mutate(model=map(data, ~ lm(Vote~days, .x))) #&lt;&lt;

nested_data</code></pre>
<pre><code>## # A tibble: 47 x 3
## # Groups:   state [47]
##    state data                model 
##    &lt;chr&gt; &lt;list&gt;              &lt;list&gt;
##  1 MT    &lt;tibble [18 × 18]&gt;  &lt;lm&gt;  
##  2 ME    &lt;tibble [19 × 18]&gt;  &lt;lm&gt;  
##  3 IA    &lt;tibble [32 × 18]&gt;  &lt;lm&gt;  
##  4 WI    &lt;tibble [95 × 18]&gt;  &lt;lm&gt;  
##  5 PA    &lt;tibble [112 × 18]&gt; &lt;lm&gt;  
##  6 NC    &lt;tibble [104 × 18]&gt; &lt;lm&gt;  
##  7 MI    &lt;tibble [112 × 18]&gt; &lt;lm&gt;  
##  8 FL    &lt;tibble [105 × 18]&gt; &lt;lm&gt;  
##  9 AZ    &lt;tibble [88 × 18]&gt;  &lt;lm&gt;  
## 10 MN    &lt;tibble [34 × 18]&gt;  &lt;lm&gt;  
## # … with 37 more rows</code></pre>
</div>
<div id="outputs-from-unnest" class="section level2">
<h2>Outputs from Unnest</h2>
<pre class="r"><code># first, remove the intercept
to_plot &lt;- nested_data %&gt;%
              filter(term!=&quot;(Intercept)&quot;) %&gt;%
              mutate(ub=estimate+1.96*std.error, 
                     lb=estimate-1.96*std.error)  %&gt;%
              drop_na()
# graph
ggplot(to_plot, aes(x=fct_rev(state),y=estimate, ymin=lb, ymax=ub)) +
  geom_pointrange(shape=21, fill=&quot;blue&quot;, color=&quot;black&quot;, alpha=.8) +
  geom_hline(yintercept = 0, linetype=&quot;dashed&quot;, color=&quot;gray&quot;) +
  coord_flip() +
  theme_minimal() +
  labs(x = &quot;Linear Time Trend by State&quot;,  y= &quot;Biden Support in the Polls&quot;)  </code></pre>
<hr />
<p>class: center, middle</p>
<p><img src="static/slides/slides_files/figure-html/unnamed-chunk-38-1.png" width="672" /></p>
</div>
</div>
<div id="an-example-of-my-workflow" class="section level1">
<h1>An Example of my Workflow</h1>
<p>–</p>
<ul>
<li><p>To conclude our workshop, I will show you the code my recent paper (co-authored with Ernesto Calvo) forthcoming at the Latin American Politics and Society.</p></li>
<li><p>The paper is about partisanship and risk perceptions about COVID-19. I will focus on the descriptive analysis and the simple regression models we use to show partisan difference of risk perceptions in Brazil.</p></li>
<li><p>The paper and replication files can be found <a href="https://github.com/TiagoVentura/Calvo_Ventura_LAPS_2021">here</a>.</p></li>
<li><h2 id="our-goal-a-model-of-partisanship-on-three-different-outcomes."><strong>Our Goal</strong>: A model of partisanship on three different outcomes.</h2></li>
</ul>
<hr />
<div id="step1-tidy-your-data" class="section level2">
<h2>Step1: Tidy Your Data</h2>
<pre class="r"><code>load(&quot;CV_data.Rdata&quot;)
library(tidyverse)
library(tidyr)

# Untidy
d %&gt;% select(covid_job, covid_health, covid_government)</code></pre>
<pre><code>## # A tibble: 2,362 x 3
##    covid_job         covid_health      covid_government      
##    &lt;fct&gt;             &lt;fct&gt;             &lt;fct&gt;                 
##  1 Very unlikely     Somewhat unlikely Somewhat Unappropriate
##  2 Very unlikely     Somewhat Likely   Somewhat Appropriate  
##  3 Very Likely       Very Likely       Very Appropriate      
##  4 Very Likely       Very Likely       Somewhat Unappropriate
##  5 Somewhat Likely   Somewhat Likely   Somewhat Appropriate  
##  6 Somewhat Likely   Somewhat unlikely Somewhat Appropriate  
##  7 Very unlikely     Somewhat Likely   Very Appropriate      
##  8 Somewhat unlikely Somewhat Likely   Very Appropriate      
##  9 Very unlikely     Somewhat Likely   Somewhat Unappropriate
## 10 Very Likely       Somewhat unlikely Somewhat Unappropriate
## # … with 2,352 more rows</code></pre>
<hr />
</div>
<div id="make-it-tidy" class="section level2">
<h2>Make it tidy</h2>
<pre class="r"><code>d_pivot &lt;- d %&gt;% 
            pivot_longer(cols=c(covid_job, covid_health, 
                                covid_government), 
                         names_to=&quot;covid&quot;, 
                         values_to=&quot;covid_values&quot;) </code></pre>
<hr />
</div>
<div id="what-do-i-have-now" class="section level2">
<h2>What do I have now?</h2>
<pre><code>## # A tibble: 7,086 x 2
##    covid            covid_values          
##    &lt;chr&gt;            &lt;fct&gt;                 
##  1 covid_job        Very unlikely         
##  2 covid_health     Somewhat unlikely     
##  3 covid_government Somewhat Unappropriate
##  4 covid_job        Very unlikely         
##  5 covid_health     Somewhat Likely       
##  6 covid_government Somewhat Appropriate  
##  7 covid_job        Very Likely           
##  8 covid_health     Very Likely           
##  9 covid_government Very Appropriate      
## 10 covid_job        Very Likely           
## # … with 7,076 more rows</code></pre>
<hr />
</div>
<div id="nest-and-models" class="section level2">
<h2>Nest and Models</h2>
<pre class="r"><code>data_nested &lt;- d_pivot %&gt;%
                group_by(covid) %&gt;%
                nest() %&gt;%
                mutate(model=map(data, ~ 
                              lm(as.numeric(covid_values) ~ #&lt;&lt;
                                 runoff_haddad +  #&lt;&lt;
                                 runoff_bolsonaro + #&lt;&lt;
                                 income + gender + work + #&lt;&lt;
                                 as.numeric(education) + age , data=.x)), #&lt;&lt;
                       res=map(model,tidy)) %&gt;%
                unnest(res) %&gt;%
                mutate(lb=estimate - 1.96*std.error, 
                       up= estimate + 1.96*std.error)</code></pre>
<p><strong>Everything we need is here: group_by, nest, model, unnest. </strong></p>
<p>.center[
<img src="https://media.giphy.com/media/wbcMnfHqOJX9K/giphy.gif" />]</p>
<hr />
</div>
</div>
<div id="next-important-steps" class="section level1">
<h1>Next (Important Steps)</h1>
<ul>
<li><p>Fix the labels.</p></li>
<li><p><strong>Get your labels correct before plotting</strong>.</p></li>
<li><p>By correct I mean: names and order.</p></li>
</ul>
<p>–</p>
<pre class="r"><code>to_plot &lt;- data_nested %&gt;% 
              filter(str_detect(term, &quot;runoff&quot;)) %&gt;%
              mutate(labels_iv=fct_recode(term, &quot;Haddad Voters&quot;=&quot;runoff_haddadOn&quot;, 
                                                &quot;Bolsonaro Voters&quot;=&quot;runoff_bolsonaroOn&quot;)) %&gt;%
              mutate(outcome= ifelse(covid==&quot;covid_job&quot;, 
                         &quot;How likely is it that you \n could lose your job? &quot;,
                         ifelse(covid==&quot;covid_health&quot;, 
                                &quot;How likely will your health \n be affected by COVID-19?&quot;, 
                                &quot;Has the government response \n been appropriate ?&quot;))) </code></pre>
<p>class: center, middle</p>
<p><img src="static/slides/slides_files/figure-html/unnamed-chunk-45-1.png" width="672" /></p>
</div>
